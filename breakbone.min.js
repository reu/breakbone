var bb={};bb.nextObjectId=1;bb.objectId=function(object){if(object){if(typeof object.objectId=="undefined"){Object.defineProperty(object,"objectId",{enumerable:false,writable:false,configurable:false,value:bb.nextObjectId++})}return object.objectId}};Array.prototype.remove=function(item){for(var i=0,length=this.length;i<length;i++){if(this[i]===item){this.splice(i,1);return true}}return false};Array.prototype.contains=function(item){for(var i=0,length=this.length;i<length;i++){if(this[i]===item){return true}}return false};Array.prototype.clear=function(){while(this.length>0){this.pop()}};if(typeof window!="undefined")window.bb=bb;if(typeof global!="undefined")global.bb=bb;bb.Class=function Class(){};bb.Class.extend=function(properties){var parent=this.prototype;var child=Object.create(parent);for(var name in properties){var property=properties[name];var parentProperty=parent[name];if(typeof property=="function"&&typeof parentProperty=="function"){child[name]=function(parentFn,fn){return function(){var tmp=this.parent;this.parent=parentFn;var ret=fn.apply(this,arguments);this.parent=tmp;if(typeof this.parent=="undefined")delete this.parent;return ret}}(parentProperty,property)}else{child[name]=properties[name]}}function Class(){if(child.init)child.init.apply(this,arguments)}Class.prototype=child;Class.prototype.constructor=Class;Class.extend=bb.Class.extend;return Class};bb.Set=bb.Class.extend({init:function(){this.length=0;this.data={}},add:function(item){if(!this.contains(item)){this.length+=1;this.data[bb.objectId(item)]=item;return true}return false},remove:function(item){if(this.contains(item)){delete this.data[bb.objectId(item)];this.length-=1;return true}return false},contains:function(item){return typeof this.data[bb.objectId(item)]!="undefined"},clear:function(){this.data={};this.length=0},forEach:function(callback,scope){scope=scope||this;for(var key in this.data){callback.call(scope,this.data[key])}}});bb.Entity=bb.Class.extend({init:function(world){this.world=world;this.id=bb.objectId(this)},hasComponent:function(componentType){return!!this.getComponent(componentType)},addComponent:function(component){this.world.addEntityComponent(this,component);this[component.type]=component;return this},getComponents:function(){return this.world.getEntityComponents(this)},getComponent:function(componentType){return this.world.getEntityComponent(this,componentType)},removeComponent:function(component){if(typeof component=="string"){component=this.getComponent(component)}this.world.removeEntityComponent(this,component);delete this[component.type];return this},remove:function(){this.world.removeEntity(this)},enable:function(){this.world.enableEntity(this)},disable:function(){this.world.disableEntity(this)}});bb.Image=bb.Class.extend({init:function(url){this.url=url;this.isLoaded=false},load:function(onLoadCallback){if(this.isLoaded){if(onLoadCallback){onLoadCallback(this)}}else if(!this.isLoaded){this.onLoadCallback=onLoadCallback;var image=new Image;image.onload=this.onImageLoaded.bind(this);image.onerror=this.onLoadError.bind(this);image.src=this.url}},onImageLoaded:function(event){this.element=event.srcElement;this.width=this.element.width;this.height=this.element.height;this.isLoaded=true;if(this.onLoadCallback){this.onLoadCallback(this)}},onLoadError:function(){throw"Error while loading image: "+this.url}});bb.Input=bb.Class.extend({init:function(){this.bindings={};this.activeCommands={};this.mouse={x:0,y:0};this.pmouse={x:0,y:0}},startKeyboardCapture:function(container){container=container||window;container.addEventListener("keydown",this.onKeyDown.bind(this),false);container.addEventListener("keyup",this.onKeyUp.bind(this),false)},startMouseCapture:function(container){container=container||window;container.addEventListener("mouseup",this.onMouseUp.bind(this),false);container.addEventListener("mousemove",this.onMouseMove.bind(this),false);container.addEventListener("mousedown",this.onMouseDown.bind(this),false)},bind:function bind(key,action){this.bindings[key]=action},unbind:function unbind(key){delete this.bindings[key]},isPressing:function(action){for(var key in this.activeCommands){if(this.activeCommands[key]&&this.bindings[key]==action)return true}return false},onKeyDown:function(event){var keyCode=event.which||event.keyCode;this.activeCommands[keyCode]=true},onKeyUp:function(event){var keyCode=event.which||event.keyCode;delete this.activeCommands[keyCode]},onMouseDown:function(event){var button=event.which||event.button;this.activeCommands[button]=true},onMouseUp:function(event){var button=event.which||event.button;delete this.activeCommands[button]},onMouseMove:function(event){this.pmouse=this.mouse.clone();if(event.offsetX){this.mouse.x=event.offsetX;this.mouse.y=event.offsetY}else{var clientRect=this.container.getBoundingClientRect();this.mouse.x=event.pageX-Math.round(clientRect.left+window.pageXOffset);this.mouse.y=event.pageY-Math.round(clientRect.top+window.pageYOffset)}}});bb.KEY={MOUSE1:1,MOUSE2:2,RETURN:13,ENTER:13,BACKSPACE:8,TAB:9,CLEAR:12,ESC:27,ESCAPE:27,SPACE:32,DEL:46,DELETE:46,HOME:36,END:35,PAGEUP:33,PAGEDOWN:34,COMMA:188,PERIOD:190,SLASH:191,BACKTICK:192,DASH:189,EQUAL:187,SEMICOLON:186,BACKSLASH:222,LEFTBRACKET:219,RIGHTBRACKET:221,REVERSE_SLASH:220,SHIFT:16,CTRL:17,ALT:18,OPTION:18,COMMAND:91,LEFT:37,UP:38,RIGHT:39,DOWN:40};var letters=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];for(var i=0,length=letters.length;i<length;i++){bb.KEY[letters[i]]=i+65}for(var number=0;number<=9;number++){bb.KEY["NUMBER"+number]=number+48}bb.Loader=bb.Class.extend({init:function(){this.resources=[];this.loadedCount=0;this.onProgress=function(percentage,count){};this.onFinish=function(){}},add:function(){for(var i=0;i<arguments.length;i++){var resource=arguments[i];if(typeof resource.load=="function"){this.resources.push(resource)}else{throw"Invalid resource."}}return this},load:function(callback){this.loadedCount=0;this.onProgress(0,this.loadedCount);var _this=this;this.resources.forEach(function(resource){resource.load(function(){_this.loadedCount+=1;_this.onProgress(_this.loadedCount/_this.resources.length*100,_this.loadedCount);if(_this.loadedCount==_this.resources.length){_this.onFinish();callback()}})})},onProgress:function(percentage,count){},onFinish:function(){}});bb.Sound=bb.Class.extend({init:function(url){this.url=url;this._volume=1;this.isLoaded=false;this.isPaused=false;Object.defineProperty(this,"volume",{set:this.setVolume.bind(this),get:this.getVolume.bind(this)});Object.defineProperty(this,"isPlaying",{get:function(){return!this.element.ended}.bind(this)})},load:function(onLoadCallback){if(this.isLoaded){if(onLoadCallback){onLoadCallback(this)}}else{this.onLoadCallback=onLoadCallback;this.element=new Audio;this.element.preload="auto";this.element.onload=this.onAudioLoaded.bind(this);this.element.onerror=this.onLoadError.bind(this);this.element.addEventListener("canplaythrough",this.onAudioLoaded.bind(this),false);this.element.addEventListener("error",this.onLoadError.bind(this),false);this.element.src=this.url;this.element.load()}},play:function(loop){if(!this.isLoaded)return;if(typeof loop!="undefined"&&typeof loop!="null"){this.element.loop=!!loop}this.element.play();this.element.isPaused=false},stop:function(){this.element.pause();this.element.currentTime=0},pause:function(){this.element.pause();this.isPaused=true},setVolume:function(volume){this._volume=volume;this.element.volume=this._volume*bb.Sound.masterVolume},getVolume:function(){return this._volume},onAudioLoaded:function(event){this.isLoaded=true;this.setVolume(this.volume);bb.Sound.sounds.push(this);if(this.onLoadCallback){this.onLoadCallback(this)}},onLoadError:function(){throw"Error while loading sound: "+this.url}});bb.Sound.sounds=[];bb.Sound._masterVolume=1;bb.Sound.setMasterVolume=function(volume){bb.Sound._masterVolume=volume;bb.Sound.sounds.forEach(function(sound){sound.setVolume(sound.volume)})};bb.Sound.getMasterVolume=function(){return bb.Sound._masterVolume};Object.defineProperty(bb.Sound,"masterVolume",{set:bb.Sound.setMasterVolume,get:bb.Sound.getMasterVolume});bb.Sound.pause=function(){bb.Sound.sounds.forEach(function(sound){if(sound.isPlaying){sound.pause()}})};bb.Sound.stop=function(){bb.Sound.sounds.forEach(function(sound){if(sound.isPlaying){sound.stop()}})};bb.Sound.resume=function(){bb.Sound.sounds.forEach(function(sound){if(sound.isPaused){sound.play()}})};bb.World=bb.Class.extend({init:function(){this.systems=[];this.entities=[];this.disabledEntities=[];this.addedEntities=[];this.changedEntities=[];this.disabledEntities=[];this.enabledEntities=[];this.removedEntities=[];this.components={}},process:function(){this.notifySystems();this.processSystems()},check:function(entities,action){if(entities.length){for(var i=0,length=entities.length;i<length;i++){for(var j=0;j<this.systems.length;j++){action(entities[i],this.systems[i])}}entities.clear()}},notifySystems:function(){this.check(this.addedEntities,function(entity,system){system.entityAdded(entity)});this.check(this.changedEntities,function(entity,system){system.entityChanged(entity)});this.check(this.disabledEntities,function(entity,system){system.entityDisabled(entity)});this.check(this.enabledEntities,function(entity,system){system.entityEnabled(entity)});this.check(this.removedEntities,function(entity,system){system.entityRemoved(entity)})},processSystems:function(){for(var i=0,length=this.systems.length;i<length;i++){this.systems[i].process()}},createEntity:function(){var entity=new bb.Entity(this);this.addEntity(entity);return entity},addEntity:function(entity){this.entities.push(entity);this.addedEntities.push(entity)},addSystem:function(system){this.systems.push(system)},removeEntity:function(entity){this.entities.remove(entity);this.removedEntities.push(entity)},changeEntity:function(entity){this.changedEntities.push(entity)},enableEntity:function(entity){this.enabledEntities.push(entity)},disableEntity:function(entity){this.disabledEntities.push(entity)},addEntityComponent:function(entity,component){var components=this.getComponentsByType(component.type);components[entity.id]=component;return component},getEntityComponent:function(entity,componentType){var components=this.getComponentsByType(componentType);for(var entityId in components){if(entityId==entity.id){return components[entityId]}}},getEntityComponents:function(entity){var components=[];for(var type in this.components){for(var entityId in this.components[type]){if(entityId==entity.id){components.push(this.components[type][entityId])}}}return components},removeEntityComponent:function(entity,component){delete this.components[component.type][entity.id]},getComponentsByType:function(componentType){if(!this.components[componentType]){this.components[componentType]={}}return this.components[componentType]}});bb.System=bb.Class.extend({init:function(){this.entities=new bb.Set},process:function(){},allowEntity:function(entity){throw"Not implemented"},onEntityAdd:function(entity){},onEntityChange:function(entity){},onEntityRemoval:function(entity){},onEntityEnable:function(entity){},onEntityDisable:function(entity){},addEntity:function(entity){if(this.entities.add(entity)){this.onEntityAdd(entity)}},removeEntity:function(entity){if(this.entities.remove(entity)){this.onEntityRemoval(entity)}},entityAdded:function(entity){if(this.allowEntity(entity)){this.addEntity(entity)}},entityRemoved:function(entity){this.removeEntity(entity)},entityChanged:function(entity){if(this.allowEntity(entity)){if(this.entities.contains(entity)){this.onEntityChange(entity)}else{this.addEntity(entity)}}else{this.removeEntity(entity)}},entityEnabled:function(entity){if(this.allowEntity(entity)){this.entities.add(entity);this.onEntityEnable(entity)}},entityDisabled:function(entity){if(this.entities.remove(entity)){this.onEntityDisable(entity)}}});bb.Component=bb.Class.extend({type:"component"});