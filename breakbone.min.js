bb=function(){"use strict";var bb={};var nextObjectId=0;bb.objectId=function(object){if(object){if(typeof object.objectId=="undefined"){Object.defineProperty(object,"objectId",{enumerable:false,writable:false,configurable:false,value:nextObjectId++})}return object.objectId}};return bb}();bb.Vector=function(){"use strict";class Vector{constructor(x,y){this.x=x||0;this.y=y||0}add(vector){this.x+=vector.x;this.y+=vector.y;return this}subtract(vector){this.x-=vector.x;this.y-=vector.y;return this}multiply(scalar){this.x*=scalar;this.y*=scalar;return this}divide(scalar){this.x/=scalar;this.y/=scalar;return this}lengthSquared(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.lengthSquared())}normalize(){var length=this.length();if(length>0&&length!=1)this.divide(length);return this}limit(max){if(this.length()>max)return this.normalize()&&this.multiply(max)}dot(vector){return this.x*vector.x+this.y*vector.y}distance(vector){var dx=this.x-vector.x,dy=this.y-vector.y;return Math.sqrt(dx*dx+dy*dy)}reverse(){this.x*=-1;this.y*=-1;return this}clone(){return new Vector(this.x,this.y)}toString(){return"("+[this.x,this.y].join(", ")+")"}}Vector.add=function(v1,v2){return new Vector(v1.x+v2.x,v1.y+v2.y)};Vector.subtract=function(v1,v2){return new Vector(v1.x-v2.x,v1.y-v2.y)};Vector.multiply=function(vector,scalar){return new Vector(vector.x*scalar,vector.y*scalar)};Vector.divide=function(vector,scalar){return new Vector(vector.x/scalar,vector.y/scalar)};Vector.distance=function(v1,v2){var dx=v1.x-v2.x,dy=v1.y-v2.y;return Math.sqrt(dx*dx+dy*dy)};return Vector}();bb.KEY=function(){var KEY={MOUSE1:1,MOUSE2:2,RETURN:13,ENTER:13,BACKSPACE:8,TAB:9,CLEAR:12,ESC:27,ESCAPE:27,SPACE:32,DEL:46,DELETE:46,HOME:36,END:35,PAGEUP:33,PAGEDOWN:34,COMMA:188,PERIOD:190,SLASH:191,BACKTICK:192,DASH:189,EQUAL:187,SEMICOLON:186,BACKSLASH:222,LEFTBRACKET:219,RIGHTBRACKET:221,REVERSE_SLASH:220,SHIFT:16,CTRL:17,ALT:18,OPTION:18,COMMAND:91,LEFT:37,UP:38,RIGHT:39,DOWN:40};var letters=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];for(var i=0,length=letters.length;i<length;i++){KEY[letters[i]]=i+65}for(var number=0;number<=9;number++){KEY["NUMBER"+number]=number+48}return KEY}();bb.Runner=function(window){"use strict";var displayBind=window.requestAnimationFrame||window.mozRequestAnimationFrame||function(callback){window.setTimeout(callback,1e3/60)};var displayUnbind=window.cancelAnimationFrame||window.clearTimeout;class Runner{constructor(fps){this.fps=fps||60;this.onTick=function(elapsedTime){}}start(){var time=new Date;var _this=this;if(this.fps==60){this.runLoop=displayBind(function tick(){_this.onTick(new Date-time);_this.runLoop=displayBind(tick);time=new Date})}else{this.runLoop=setTimeout(function tick(){_this.onTick(new Date-time);_this.runLoop=setTimeout(tick,1e3/_this.fps);time=new Date},1e3/this.fps)}}stop(){if(this.fps==60){displayUnbind(this.runLoop)}else{window.clearTimeout(this.runLoop)}delete this.runLoop}}return Runner}(typeof window!="undefined"?window:global);bb.Entity=function(){"use strict";class Entity{constructor(world){this.world=world;this.id=bb.objectId(this)}hasComponent(componentType){return!!this.getComponent(componentType)}addComponent(component){this.world.addEntityComponent(this,component);var entity=this;Object.defineProperty(this,component.type,{enumerable:false,configurable:true,writable:false,value:component});return this}getComponents(){return this.world.getEntityComponents(this)}getComponent(componentType){return this.world.getEntityComponent(this,componentType)}removeComponent(component){if(typeof component=="string"){component=this.getComponent(component)}this.world.removeEntityComponent(this,component);delete this[component.type];return this}remove(){this.world.removeEntity(this)}enable(){this.world.enableEntity(this)}disable(){this.world.disableEntity(this)}tag(name){this.world.tagEntity(this,name);return this}untag(name){this.world.untagEntity(this,name);return this}hasTag(name){return this.world.taggedWith(name).has(this)}}return Entity}();bb.Image=function(){"use strict";class Image{constructor(url){this.url=url;this.isLoaded=false}load(onLoadCallback){if(this.isLoaded){if(onLoadCallback){onLoadCallback(this)}}else if(!this.isLoaded){this.onLoadCallback=onLoadCallback;var image=new Image;image.onload=this.onImageLoaded.bind(this);image.onerror=this.onLoadError.bind(this);image.src=this.url}}onImageLoaded(event){this.data=event.srcElement;this.width=this.data.width;this.height=this.data.height;this.isLoaded=true;if(this.onLoadCallback){this.onLoadCallback(this)}}onLoadError(){throw"Error while loading image: "+this.url}}return Image}();bb.Loader=function(){"use strict";class Loader{constructor(){this.resources=[];this.loadedCount=0;this.onProgress=function(percentage,count){};this.onFinish=function(){}}add(){for(var i=0;i<arguments.length;i++){var resource=arguments[i];if(typeof resource.load=="function"){this.resources.push(resource)}else{throw"Invalid resource."}}return this}load(callback){this.loadedCount=0;this.onProgress(0,this.loadedCount);var _this=this;this.resources.forEach(function(resource){resource.load(function(){_this.loadedCount+=1;_this.onProgress(_this.loadedCount/_this.resources.length*100,_this.loadedCount);if(_this.loadedCount==_this.resources.length){_this.onFinish();callback()}})})}onProgress(percentage,count){}onFinish(){}}return Loader}();bb.Sound=function(){"use strict";class Sound{constructor(url){this.url=url;this._volume=1;this.isLoaded=false;this.isPaused=false;Object.defineProperty(this,"volume",{set:this.setVolume.bind(this),get:this.getVolume.bind(this)});Object.defineProperty(this,"isPlaying",{get:function(){return!this.data.ended}.bind(this)})}load(onLoadCallback){if(this.isLoaded){if(onLoadCallback){onLoadCallback(this)}}else{this.onLoadCallback=onLoadCallback;this.data=new Audio;this.data.preload="auto";this.data.onload=this.onAudioLoaded.bind(this);this.data.onerror=this.onLoadError.bind(this);this.data.addEventListener("canplaythrough",this.onAudioLoaded.bind(this),false);this.data.addEventListener("error",this.onLoadError.bind(this),false);this.data.src=this.url;this.data.load()}}play(loop){if(!this.isLoaded)return;if(typeof loop!="undefined"&&typeof loop!="null"){this.data.loop=!!loop}this.data.play();this.data.isPaused=false}stop(){this.data.pause();this.data.currentTime=0}pause(){this.data.pause();this.isPaused=true}setVolume(volume){this._volume=volume;this.data.volume=this._volume*bb.Sound.masterVolume}getVolume(){return this._volume}onAudioLoaded(event){this.isLoaded=true;this.setVolume(this.volume);bb.Sound.sounds.push(this);if(this.onLoadCallback){this.onLoadCallback(this)}}onLoadError(){throw"Error while loading sound: "+this.url}}Sound.sounds=[];Sound._masterVolume=1;Sound.setMasterVolume=function(volume){bb.Sound._masterVolume=volume;bb.Sound.sounds.forEach(function(sound){sound.setVolume(sound.volume)})};Sound.getMasterVolume=function(){return bb.Sound._masterVolume};Object.defineProperty(Sound,"masterVolume",{set:Sound.setMasterVolume,get:Sound.getMasterVolume});Sound.pause=function(){bb.Sound.sounds.forEach(function(sound){if(sound.isPlaying){sound.pause()}})};Sound.stop=function(){bb.Sound.sounds.forEach(function(sound){if(sound.isPlaying){sound.stop()}})};Sound.resume=function(){bb.Sound.sounds.forEach(function(sound){if(sound.isPaused){sound.play()}})};return Sound}();bb.World=function(){"use strict";class World{constructor(){this.systems=[];this.entities=new Set;this.disabledEntities=new Set;this.addedEntities=new Set;this.changedEntities=new Set;this.disabledEntities=new Set;this.enabledEntities=new Set;this.removedEntities=new Set;this.components={};this.tags={}}process(){this.notifySystems();this.processSystems()}check(entities,action){if(entities.size){var systems=this.systems;entities.forEach(function(entity){systems.forEach(function(system){action(entity,system)})});entities.clear()}}notifySystems(){this.check(this.addedEntities,function(entity,system){system.entityAdded(entity)});this.check(this.changedEntities,function(entity,system){system.entityChanged(entity)});this.check(this.disabledEntities,function(entity,system){system.entityDisabled(entity)});this.check(this.enabledEntities,function(entity,system){system.entityEnabled(entity)});this.check(this.removedEntities,function(entity,system){system.entityRemoved(entity)})}processSystems(){for(var i=0,length=this.systems.length;i<length;i++){var system=this.systems[i];if(system.shouldProcess())system.process()}}createEntity(){var entity=new bb.Entity(this);this.addEntity(entity);return entity}addEntity(entity){this.entities.add(entity);this.addedEntities.add(entity)}addSystem(system){system.world=this;this.systems.push(system);return this}removeEntity(entity){this.entities.delete(entity);this.removedEntities.add(entity);for(var tag in this.tags){this.tags[tag].delete(entity)}}changeEntity(entity){this.changedEntities.add(entity)}enableEntity(entity){this.enabledEntities.add(entity)}disableEntity(entity){this.disabledEntities.add(entity)}addEntityComponent(entity,component){var components=this.getComponentsByType(component.type);components[entity.id]=component;this.changeEntity(entity);return component}getEntityComponent(entity,componentType){var components=this.getComponentsByType(componentType);for(var entityId in components){if(entityId==entity.id){return components[entityId]}}}getEntityComponents(entity){var components=[];for(var type in this.components){for(var entityId in this.components[type]){if(entityId==entity.id){components.push(this.components[type][entityId])}}}return components}removeEntityComponent(entity,component){this.changeEntity(entity);delete this.components[component.type][entity.id]}getComponentsByType(componentType){if(!this.components[componentType]){this.components[componentType]={}}return this.components[componentType]}tagEntity(entity,tag){if(typeof this.tags[tag]=="undefined"){this.tags[tag]=new Set}this.tags[tag].add(entity)}taggedWith(tag){return this.tags[tag]||new Set}untagEntity(entity,tag){var entities=this.tags[tag];if(entities){entities.delete(entity)}}}return World}();bb.System=function(){"use strict";class System{constructor(){this.entities=new Set}process(){}allowEntity(entity){throw"Not implemented"}shouldProcess(){return true}onEntityAdd(entity){}onEntityChange(entity){}onEntityRemoval(entity){}onEntityEnable(entity){}onEntityDisable(entity){}addEntity(entity){if(this.entities.has(entity)){this.entities.add(entity)}else{this.entities.add(entity);this.onEntityAdd(entity)}}removeEntity(entity){if(this.entities.delete(entity)){this.onEntityRemoval(entity)}}entityAdded(entity){if(this.allowEntity(entity)){this.addEntity(entity)}}entityRemoved(entity){this.removeEntity(entity)}entityChanged(entity){if(this.allowEntity(entity)){if(this.entities.has(entity)){this.onEntityChange(entity)}else{this.addEntity(entity)}}else{this.removeEntity(entity)}}entityEnabled(entity){if(this.allowEntity(entity)){this.entities.add(entity);this.onEntityEnable(entity)}}entityDisabled(entity){if(this.entities.delete(entity)){this.onEntityDisable(entity)}}}return System}();bb.VoidSystem=function(){"use strict";class VoidSystem extends bb.System{allowEntity(){}entityAdded(){}entityRemoved(){}entityChanged(){}entityEnabled(){}entityDisabled(){}}return VoidSystem}();bb.InputSystem=function(){"use strict";class InputSystem extends bb.System{constructor(container){super();this.activeCommands={};this.container=container;this.mouse={x:0,y:0};this.pmouse={x:0,y:0}}allowEntity(entity){return entity.hasComponent("input")}startKeyboardCapture(){this.container.addEventListener("keydown",this.keyDown.bind(this),false);this.container.addEventListener("keyup",this.keyUp.bind(this),false)}startMouseCapture(){this.container.addEventListener("mouseup",this.mouseUp.bind(this),false);this.container.addEventListener("mousemove",this.mouseMove.bind(this),false);this.container.addEventListener("mousedown",this.mouseDown.bind(this),false)}isPressing(keyCode){return this.activeCommands[keyCode]||false}keyDown(event){var keyCode=event.which||event.keyCode;this.activeCommands[keyCode]=true}keyUp(event){var keyCode=event.which||event.keyCode;delete this.activeCommands[keyCode]}mouseDown(event){var button=event.which||event.button;this.activeCommands[button]=true}mouseUp(event){var button=event.which||event.button;delete this.activeCommands[button]}mouseMove(event){this.pmouse=this.mouse.clone();if(event.offsetX){this.mouse.x=event.offsetX;this.mouse.y=event.offsetY}else{var clientRect=this.container.getBoundingClientRect();this.mouse.x=event.pageX-Math.round(clientRect.left+window.pageXOffset);this.mouse.y=event.pageY-Math.round(clientRect.top+window.pageYOffset)}}}return InputSystem}();bb.Component=function(){"use strict";class Component{get type(){var name=this.constructor.name.replace("Component","");if(name.length==0){throw new Error("You must define a component `type`")}else{return name[0].toLowerCase()+name.slice(1)}}}return Component}();bb.InputComponent=function(){"use strict";class InputComponent extends bb.Component{constructor(input){super();this.input=input;this.mappings={}}add(key,action){this.mappings[key]=action;return this}remove(action){for(var key in this.mappings){if(this.mappings[key]==action){delete this.mappings[key]}}}action(actionName){for(var key in this.mappings){if(this.mappings[key]==actionName){return key}}}}return InputComponent}();