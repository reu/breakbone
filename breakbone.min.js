bb=function(){"use strict";var bb={};var nextObjectId=0;bb.objectId=function(object){if(object){if(typeof object.objectId=="undefined"){Object.defineProperty(object,"objectId",{enumerable:false,writable:false,configurable:false,value:nextObjectId++})}return object.objectId}};return bb}();bb.Class=function(){"use strict";var Class=function Class(){};Class.reopen=function(properties){for(var name in properties){var property=properties[name];var currentProperty=this.prototype[name];if(typeof property=="function"&&typeof currentProperty=="function"){this.prototype[name]=function(parentFn,fn){return function(){var tmp=this.parent;this.parent=parentFn;var ret=fn.apply(this,arguments);this.parent=tmp;if(typeof this.parent=="undefined")delete this.parent;return ret}}(currentProperty,property)}else{this.prototype[name]=property}}};Class.extend=function(properties){var parent=this.prototype;var child=Object.create(parent);for(var name in properties){var property=properties[name];var parentProperty=parent[name];if(typeof property=="function"&&typeof parentProperty=="function"){child[name]=function(parentFn,fn){return function(){var tmp=this.parent;this.parent=parentFn;var ret=fn.apply(this,arguments);this.parent=tmp;if(typeof this.parent=="undefined")delete this.parent;return ret}}(parentProperty,property)}else{child[name]=properties[name]}}function Class(){if(child.init)child.init.apply(this,arguments)}Class.prototype=child;Class.prototype.constructor=Class;Class.extend=bb.Class.extend;Class.reopen=bb.Class.reopen;return Class};return Class}();bb.Vector=function(){"use strict";var Vector=bb.Class.extend({init:function(x,y){this.x=x||0;this.y=y||0},add:function(vector){this.x+=vector.x;this.y+=vector.y;return this},subtract:function(vector){this.x-=vector.x;this.y-=vector.y;return this},multiply:function(scalar){this.x*=scalar;this.y*=scalar;return this},divide:function(scalar){this.x/=scalar;this.y/=scalar;return this},lengthSquared:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.lengthSquared())},normalize:function(){var length=this.length();if(length>0&&length!=1)this.divide(length);return this},limit:function(max){if(this.length()>max)return this.normalize()&&this.multiply(max)},dot:function(vector){return this.x*vector.x+this.y*vector.y},distance:function(vector){var dx=this.x-vector.x,dy=this.y-vector.y;return Math.sqrt(dx*dx+dy*dy)},reverse:function(){this.x*=-1;this.y*=-1;return this},clone:function(){return new Vector(this.x,this.y)},toString:function(){return"("+[this.x,this.y].join(", ")+")"}});Vector.add=function(v1,v2){return new Vector(v1.x+v2.x,v1.y+v2.y)};Vector.subtract=function(v1,v2){return new Vector(v1.x-v2.x,v1.y-v2.y)};Vector.multiply=function(vector,scalar){return new Vector(vector.x*scalar,vector.y*scalar)};Vector.divide=function(vector,scalar){return new Vector(vector.x/scalar,vector.y/scalar)};Vector.distance=function(v1,v2){var dx=v1.x-v2.x,dy=v1.y-v2.y;return Math.sqrt(dx*dx+dy*dy)};return Vector}();bb.KEY=function(){var KEY={MOUSE1:1,MOUSE2:2,RETURN:13,ENTER:13,BACKSPACE:8,TAB:9,CLEAR:12,ESC:27,ESCAPE:27,SPACE:32,DEL:46,DELETE:46,HOME:36,END:35,PAGEUP:33,PAGEDOWN:34,COMMA:188,PERIOD:190,SLASH:191,BACKTICK:192,DASH:189,EQUAL:187,SEMICOLON:186,BACKSLASH:222,LEFTBRACKET:219,RIGHTBRACKET:221,REVERSE_SLASH:220,SHIFT:16,CTRL:17,ALT:18,OPTION:18,COMMAND:91,LEFT:37,UP:38,RIGHT:39,DOWN:40};var letters=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];for(var i=0,length=letters.length;i<length;i++){KEY[letters[i]]=i+65}for(var number=0;number<=9;number++){KEY["NUMBER"+number]=number+48}return KEY}();bb.Runner=function(window){var displayBind=window.requestAnimationFrame||window.mozRequestAnimationFrame||function(callback){window.setTimeout(callback,1e3/60)};var displayUnbind=window.cancelAnimationFrame||window.clearTimeout;var Runner=bb.Class.extend({init:function(fps){this.fps=fps||60;this.onTick=function(elapsedTime){}},start:function(){var time=new Date;var _this=this;if(this.fps==60){this.runLoop=displayBind(function tick(){_this.onTick(new Date-time);_this.runLoop=displayBind(tick);time=new Date})}else{this.runLoop=setTimeout(function tick(){_this.onTick(new Date-time);_this.runLoop=setTimeout(tick,1e3/_this.fps);time=new Date},1e3/this.fps)}},stop:function(){if(this.fps==60){displayUnbind(this.runLoop)}else{window.clearTimeout(this.runLoop)}delete this.runLoop}});return Runner}(typeof window!="undefined"?window:global);bb.Entity=function(){"use strict";var Entity=bb.Class.extend({init:function(world){this.world=world;this.id=bb.objectId(this)},hasComponent:function(componentType){return!!this.getComponent(componentType)},addComponent:function(component){this.world.addEntityComponent(this,component);this[component.type]=component;return this},getComponents:function(){return this.world.getEntityComponents(this)},getComponent:function(componentType){return this.world.getEntityComponent(this,componentType)},removeComponent:function(component){if(typeof component=="string"){component=this.getComponent(component)}this.world.removeEntityComponent(this,component);delete this[component.type];return this},remove:function(){this.world.removeEntity(this)},enable:function(){this.world.enableEntity(this)},disable:function(){this.world.disableEntity(this)},tag:function(name){this.world.tagEntity(this,name);return this},untag:function(name){this.world.untagEntity(this,name);return this},hasTag:function(name){return this.world.taggedWith(name).has(this)}});return Entity}();bb.Image=function(){"use strict";bb.Image=bb.Class.extend({init:function(url){this.url=url;this.isLoaded=false},load:function(onLoadCallback){if(this.isLoaded){if(onLoadCallback){onLoadCallback(this)}}else if(!this.isLoaded){this.onLoadCallback=onLoadCallback;var image=new Image;image.onload=this.onImageLoaded.bind(this);image.onerror=this.onLoadError.bind(this);image.src=this.url}},onImageLoaded:function(event){this.data=event.srcElement;this.width=this.data.width;this.height=this.data.height;this.isLoaded=true;if(this.onLoadCallback){this.onLoadCallback(this)}},onLoadError:function(){throw"Error while loading image: "+this.url}});return bb.Image}();bb.Loader=function(){"use strict";var Loader=bb.Class.extend({init:function(){this.resources=[];this.loadedCount=0;this.onProgress=function(percentage,count){};this.onFinish=function(){}},add:function(){for(var i=0;i<arguments.length;i++){var resource=arguments[i];if(typeof resource.load=="function"){this.resources.push(resource)}else{throw"Invalid resource."}}return this},load:function(callback){this.loadedCount=0;this.onProgress(0,this.loadedCount);var _this=this;this.resources.forEach(function(resource){resource.load(function(){_this.loadedCount+=1;_this.onProgress(_this.loadedCount/_this.resources.length*100,_this.loadedCount);if(_this.loadedCount==_this.resources.length){_this.onFinish();callback()}})})},onProgress:function(percentage,count){},onFinish:function(){}});return Loader}();bb.Sound=function(){"use strict";var Sound=bb.Class.extend({init:function(url){this.url=url;this._volume=1;this.isLoaded=false;this.isPaused=false;Object.defineProperty(this,"volume",{set:this.setVolume.bind(this),get:this.getVolume.bind(this)});Object.defineProperty(this,"isPlaying",{get:function(){return!this.data.ended}.bind(this)})},load:function(onLoadCallback){if(this.isLoaded){if(onLoadCallback){onLoadCallback(this)}}else{this.onLoadCallback=onLoadCallback;this.data=new Audio;this.data.preload="auto";this.data.onload=this.onAudioLoaded.bind(this);this.data.onerror=this.onLoadError.bind(this);this.data.addEventListener("canplaythrough",this.onAudioLoaded.bind(this),false);this.data.addEventListener("error",this.onLoadError.bind(this),false);this.data.src=this.url;this.data.load()}},play:function(loop){if(!this.isLoaded)return;if(typeof loop!="undefined"&&typeof loop!="null"){this.data.loop=!!loop}this.data.play();this.data.isPaused=false},stop:function(){this.data.pause();this.data.currentTime=0},pause:function(){this.data.pause();this.isPaused=true},setVolume:function(volume){this._volume=volume;this.data.volume=this._volume*bb.Sound.masterVolume},getVolume:function(){return this._volume},onAudioLoaded:function(event){this.isLoaded=true;this.setVolume(this.volume);bb.Sound.sounds.push(this);if(this.onLoadCallback){this.onLoadCallback(this)}},onLoadError:function(){throw"Error while loading sound: "+this.url}});Sound.sounds=[];Sound._masterVolume=1;Sound.setMasterVolume=function(volume){bb.Sound._masterVolume=volume;bb.Sound.sounds.forEach(function(sound){sound.setVolume(sound.volume)})};Sound.getMasterVolume=function(){return bb.Sound._masterVolume};Object.defineProperty(Sound,"masterVolume",{set:Sound.setMasterVolume,get:Sound.getMasterVolume});Sound.pause=function(){bb.Sound.sounds.forEach(function(sound){if(sound.isPlaying){sound.pause()}})};Sound.stop=function(){bb.Sound.sounds.forEach(function(sound){if(sound.isPlaying){sound.stop()}})};Sound.resume=function(){bb.Sound.sounds.forEach(function(sound){if(sound.isPaused){sound.play()}})};return Sound}();bb.World=function(){"use strict";var World=bb.Class.extend({init:function(){this.systems=[];this.entities=new Set;this.disabledEntities=new Set;this.addedEntities=new Set;this.changedEntities=new Set;this.disabledEntities=new Set;this.enabledEntities=new Set;this.removedEntities=new Set;this.components={};this.tags={}},process:function(){this.notifySystems();this.processSystems()},check:function(entities,action){if(entities.size){var systems=this.systems;entities.forEach(function(entity){systems.forEach(function(system){action(entity,system)})});entities.clear()}},notifySystems:function(){this.check(this.addedEntities,function(entity,system){system.entityAdded(entity)});this.check(this.changedEntities,function(entity,system){system.entityChanged(entity)});this.check(this.disabledEntities,function(entity,system){system.entityDisabled(entity)});this.check(this.enabledEntities,function(entity,system){system.entityEnabled(entity)});this.check(this.removedEntities,function(entity,system){system.entityRemoved(entity)})},processSystems:function(){for(var i=0,length=this.systems.length;i<length;i++){var system=this.systems[i];if(system.shouldProcess())system.process()}},createEntity:function(){var entity=new bb.Entity(this);this.addEntity(entity);return entity},addEntity:function(entity){this.entities.add(entity);this.addedEntities.add(entity)},addSystem:function(system){system.world=this;this.systems.push(system);return this},removeEntity:function(entity){this.entities.delete(entity);this.removedEntities.add(entity);for(var tag in this.tags){this.tags[tag].delete(entity)}},changeEntity:function(entity){this.changedEntities.add(entity)},enableEntity:function(entity){this.enabledEntities.add(entity)},disableEntity:function(entity){this.disabledEntities.add(entity)},addEntityComponent:function(entity,component){var components=this.getComponentsByType(component.type);components[entity.id]=component;this.changeEntity(entity);return component},getEntityComponent:function(entity,componentType){var components=this.getComponentsByType(componentType);for(var entityId in components){if(entityId==entity.id){return components[entityId]}}},getEntityComponents:function(entity){var components=[];for(var type in this.components){for(var entityId in this.components[type]){if(entityId==entity.id){components.push(this.components[type][entityId])}}}return components},removeEntityComponent:function(entity,component){this.changeEntity(entity);delete this.components[component.type][entity.id]},getComponentsByType:function(componentType){if(!this.components[componentType]){this.components[componentType]={}}return this.components[componentType]},tagEntity:function(entity,tag){if(typeof this.tags[tag]=="undefined"){this.tags[tag]=new Set}this.tags[tag].add(entity)},taggedWith:function(tag){return this.tags[tag]||new Set},untagEntity:function(entity,tag){var entities=this.tags[tag];if(entities){entities.delete(entity)}}});return World}();bb.System=function(){"use strict";var System=bb.Class.extend({init:function(){this.entities=new Set},process:function(){},allowEntity:function(entity){throw"Not implemented"},shouldProcess:function(){return true},onEntityAdd:function(entity){},onEntityChange:function(entity){},onEntityRemoval:function(entity){},onEntityEnable:function(entity){},onEntityDisable:function(entity){},addEntity:function(entity){if(this.entities.has(entity)){this.entities.add(entity)}else{this.entities.add(entity);this.onEntityAdd(entity)}},removeEntity:function(entity){if(this.entities.delete(entity)){this.onEntityRemoval(entity)}},entityAdded:function(entity){if(this.allowEntity(entity)){this.addEntity(entity)}},entityRemoved:function(entity){this.removeEntity(entity)},entityChanged:function(entity){if(this.allowEntity(entity)){if(this.entities.has(entity)){this.onEntityChange(entity)}else{this.addEntity(entity)}}else{this.removeEntity(entity)}},entityEnabled:function(entity){if(this.allowEntity(entity)){this.entities.add(entity);this.onEntityEnable(entity)}},entityDisabled:function(entity){if(this.entities.delete(entity)){this.onEntityDisable(entity)}}});return System}();bb.VoidSystem=function(){var VoidSystem=bb.System.extend({allowEntity:function(){},entityAdded:function(){},entityRemoved:function(){},entityChanged:function(){},entityEnabled:function(){},entityDisabled:function(){}});return VoidSystem}();bb.InputSystem=function(){"use strict";var InputSystem=bb.System.extend({init:function(container){this.parent();this.activeCommands={};this.container=container;this.mouse={x:0,y:0};this.pmouse={x:0,y:0}},allowEntity:function(entity){return entity.hasComponent("input")},startKeyboardCapture:function(){this.container.addEventListener("keydown",this.keyDown.bind(this),false);this.container.addEventListener("keyup",this.keyUp.bind(this),false)},startMouseCapture:function(){this.container.addEventListener("mouseup",this.mouseUp.bind(this),false);this.container.addEventListener("mousemove",this.mouseMove.bind(this),false);this.container.addEventListener("mousedown",this.mouseDown.bind(this),false)},isPressing:function(keyCode){return this.activeCommands[keyCode]||false},keyDown:function(event){var keyCode=event.which||event.keyCode;this.activeCommands[keyCode]=true},keyUp:function(event){var keyCode=event.which||event.keyCode;delete this.activeCommands[keyCode]},mouseDown:function(event){var button=event.which||event.button;this.activeCommands[button]=true},mouseUp:function(event){var button=event.which||event.button;delete this.activeCommands[button]},mouseMove:function(event){this.pmouse=this.mouse.clone();if(event.offsetX){this.mouse.x=event.offsetX;this.mouse.y=event.offsetY}else{var clientRect=this.container.getBoundingClientRect();this.mouse.x=event.pageX-Math.round(clientRect.left+window.pageXOffset);this.mouse.y=event.pageY-Math.round(clientRect.top+window.pageYOffset)}}});return InputSystem}();bb.Component=function(){"use strict";var Component=bb.Class.extend({type:"component"});return Component}();bb.InputComponent=function(){"use strict";var InputComponent=bb.Component.extend({type:"input",init:function(input){this.input=input;this.mappings={}},add:function(key,action){this.mappings[key]=action;return this},remove:function(action){for(var key in this.mappings){if(this.mappings[key]==action){delete this.mappings[key]}}},action:function(actionName){for(var key in this.mappings){if(this.mappings[key]==actionName){return key}}}});return InputComponent}();